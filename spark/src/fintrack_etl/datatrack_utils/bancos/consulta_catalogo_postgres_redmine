/* Levantar Dados CatÃ¡logo */
WITH tabelas_properties AS (
SELECT DISTINCT
    'redmine' AS "sistema",
    'postgres' AS "banco",
    n.nspname AS "esquema",
    c.relname AS "tabela",
    'full' AS "tipo_carga",
    '' AS "query",
    '' AS "coluna_particao",
    '' AS "tipo_coluna_particao",
    COALESCE(
        (
            SELECT string_agg(a.attname, ',' ORDER BY a.attnum)
            FROM pg_constraint conp
            JOIN pg_attribute a
              ON a.attrelid = conp.conrelid
             AND a.attnum = ANY(conp.conkey)
            WHERE conp.conrelid = c.oid
              AND conp.contype = 'p'
        ),
        (
            SELECT string_agg(a.attname, ',' ORDER BY a.attnum)
            FROM pg_constraint conu
            JOIN pg_attribute a
              ON a.attrelid = conu.conrelid
             AND a.attnum = ANY(conu.conkey)
            WHERE conu.conrelid = c.oid
              AND conu.contype = 'u'
              AND conu.oid = (
                  SELECT MIN(cu.oid)
                  FROM pg_constraint cu
                  WHERE cu.conrelid = c.oid
                    AND cu.contype = 'u'
              )
        )
    ) AS "chaves",
    1 AS lowerbound,
    c.reltuples::bigint AS upperbound,
    GREATEST(ROUND(c.reltuples::bigint / 1000000::numeric), 1) AS numpartitions,
    -- Calcular o tamanho da tabela e divide cada particao gigas o tamanho de cada particao 
    --greatest(round(round((pg_total_relation_size(quote_ident(n.nspname) || '.' || quote_ident(c.relname)) / (1024.0 * 1024.0 * 1024.0)),3)),1) AS numpartitions,
    'True' AS create_row_number,
    '' AS condition
FROM pg_catalog.pg_class c
JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'  -- somente tabelas reais
)
select 
	tp."sistema",
 	tp."banco",
 	tp."esquema",
 	tp."tabela",
 	tp."tipo_carga",
 	tp."query",
 	tp."coluna_particao",
 	tp."tipo_coluna_particao",
 	tp."chaves",
 	CASE WHEN tp."chaves" IS NOT NULL THEN 'row_partition' ELSE NULL END "nome_coluna_delta",
 	CASE WHEN tp."chaves" IS NOT NULL THEN 'integer' ELSE NULL END  "type_delta",
 	tp."lowerbound",
 	tp."upperbound",
 	tp."numpartitions",
    CASE WHEN tp."chaves" IS NOT NULL THEN 'True' ELSE 'False' end  create_row_number,
    '' AS "condition"
from tabelas_properties tp;


-- Encontrar Chaves Unicas apartir agrupamentos
select 
	1
from public.schema_migrations
group by  version -- Colunas para testar agrupamento
having count(*) > 1
;
select * from public.schema_migrations;